clear 
close all
%parameters
a = .95; b = .95; L = 70;  T_amb = 21.29; k = 2.37; h = .00191; Phi = -18.4;  x = 10:4:L;

h_f = 1e-8;

% Derivatives Using Finite Difference
f_Phi_fin = (analytic(x,k,h,Phi+h_f)-analytic(x,k,h,Phi))/h_f; 
f_h_fin = (analytic(x,k,h+h_f,Phi)-analytic(x,k,h,Phi))/h_f;
f_k_fin = (analytic(x,k+h_f,h,Phi)-analytic(x,k,h,Phi))/h_f;

% Derivatives Using Complex-step approximation
h_c=1e-16;

f_Phi_com = imag(analytic(x,k,h,complex(Phi,h_c)))/h_c; 
f_h_com = imag(analytic(x,k,complex(h,h_c),Phi))/h_c;
f_k_com = imag(analytic(x,complex(k,h_c),h,Phi))/h_c;

f_k = (35*Phi.*exp(-x.*((80.*h)/(19.*k))^(1/2)).*exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)))/(k^2.*(exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)) + exp(-70.*((80.*h)/(19.*k))^(1/2)).*(h - k.*((80.*h)/(19.*k))^(1/2)))) - (40.*h.*x.*exp(x.*((80.*h)/(19.*k))^(1/2)).*(Phi/(k.*((80.*h)/(19.*k))^(1/2)) - (Phi.*exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)))/(k.*(exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)) + exp(-70.*((80.*h)/(19.*k))^(1/2)).*(h - k.*((80.*h)/(19.*k))^(1/2))).*((80.*h)/(19.*k))^(1/2))))/(19.*k^2.*((80.*h)/(19.*k))^(1/2)) - exp(x.*((80.*h)/(19.*k))^(1/2)).*(Phi/(k^2.*((80.*h)/(19.*k))^(1/2)) - (40.*Phi.*h)/(19.*k^3.*((80.*h)/(19.*k))^(3/2)) - (35.*Phi.*exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)))/(k^2.*(exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)) + exp(-70.*((80.*h)/(19.*k))^(1/2)).*(h - k.*((80.*h)/(19.*k))^(1/2)))) - (Phi.*exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)))/(k^2.*(exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)) + exp(-70.*((80.*h)/(19.*k))^(1/2)).*(h - k.*((80.*h)/(19.*k))^(1/2))).*((80.*h)/(19.*k))^(1/2)) + (Phi.*exp(70.*((80.*h)/(19.*k))^(1/2)).*(((80.*h)/(19.*k))^(1/2) - (40.*h)/(19.*k.*((80.*h)/(19.*k))^(1/2))))/(k.*(exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)) + exp(-70.*((80.*h)/(19.*k))^(1/2)).*(h - k.*((80.*h)/(19.*k))^(1/2))).*((80.*h)/(19.*k))^(1/2)) + (Phi.*exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)).*(exp(-70.*((80.*h)/(19.*k))^(1/2)).*(((80.*h)/(19.*k))^(1/2) - (40.*h)/(19.*k.*((80.*h)/(19.*k))^(1/2))) - exp(70.*((80.*h)/(19.*k))^(1/2)).*(((80.*h)/(19.*k))^(1/2) - (40.*h)/(19.*k.*((80.*h)/(19.*k))^(1/2))) + (2800.*h.*exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)))/(19.*k^2.*((80.*h)/(19.*k))^(1/2)) - (2800.*h.*exp(-70.*((80.*h)/(19.*k))^(1/2)).*(h - k.*((80.*h)/(19.*k))^(1/2)))/(19.*k^2.*((80.*h)/(19.*k))^(1/2))))/(k.*(exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)) + exp(-70.*((80.*h)/(19.*k))^(1/2)).*(h - k.*((80.*h)/(19.*k))^(1/2)))^2.*((80.*h)/(19.*k))^(1/2)) + (40.*Phi.*h.*exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)))/(19.*k^3.*(exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)) + exp(-70.*((80.*h)/(19.*k))^(1/2)).*(h - k.*((80.*h)/(19.*k))^(1/2))).*((80.*h)/(19.*k))^(3/2))) - (Phi.*exp(-x.*((80.*h)/(19.*k))^(1/2)).*exp(70.*((80.*h)/(19.*k))^(1/2)).*(((80.*h)/(19.*k))^(1/2) - (40.*h)/(19.*k.*((80.*h)/(19.*k))^(1/2))))/(k.*(exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)) + exp(-70.*((80.*h)/(19.*k))^(1/2)).*(h - k.*((80.*h)/(19.*k))^(1/2))).*((80.*h)/(19.*k))^(1/2)) - (Phi.*x.*exp(-x.*((80.*h)/(19.*k))^(1/2)).*exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)))/(2.*k^2.*(exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)) + exp(-70.*((80.*h)/(19.*k))^(1/2)).*(h - k.*((80.*h)/(19.*k))^(1/2)))) + (Phi.*exp(-x.*((80.*h)/(19.*k))^(1/2)).*exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)))/(k^2.*(exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)) + exp(-70.*((80.*h)/(19.*k))^(1/2)).*(h - k.*((80.*h)/(19.*k))^(1/2))).*((80.*h)/(19.*k))^(1/2)) - (40.*Phi.*h.*exp(-x.*((80.*h)/(19.*k))^(1/2)).*exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)))/(19.*k^3.*(exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)) + exp(-70.*((80.*h)/(19.*k))^(1/2)).*(h - k.*((80.*h)/(19.*k))^(1/2))).*((80.*h)/(19.*k))^(3/2)) - (Phi.*exp(-x.*((80.*h)/(19.*k))^(1/2)).*exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)).*(exp(-70.*((80.*h)/(19.*k))^(1/2)).*(((80.*h)/(19.*k))^(1/2) - (40.*h)/(19.*k.*((80.*h)/(19.*k))^(1/2))) - exp(70.*((80.*h)/(19.*k))^(1/2)).*(((80.*h)/(19.*k))^(1/2) - (40.*h)/(19.*k.*((80.*h)/(19.*k))^(1/2))) + (2800.*h.*exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)))/(19.*k^2.*((80.*h)/(19.*k))^(1/2)) - (2800.*h.*exp(-70.*((80.*h)/(19.*k))^(1/2)).*(h - k.*((80.*h)/(19.*k))^(1/2)))/(19.*k^2.*((80.*h)/(19.*k))^(1/2))))/(k.*(exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)) + exp(-70.*((80.*h)/(19.*k))^(1/2)).*(h - k.*((80.*h)/(19.*k))^(1/2)))^2.*((80.*h)/(19.*k))^(1/2)); 

f_h=(40.*x.*exp(x.*((80.*h)/(19.*k))^(1/2)).*(Phi/(k.*((80.*h)/(19.*k))^(1/2)) - (Phi.*exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)))/(k.*(exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)) + exp(-70.*((80.*h)/(19.*k))^(1/2)).*(h - k.*((80.*h)/(19.*k))^(1/2))).*((80.*h)/(19.*k))^(1/2))))/(19.*k.*((80.*h)/(19.*k))^(1/2)) - exp(x.*((80.*h)/(19.*k))^(1/2)).*((40.*Phi)/(19.*k^2.*((80.*h)/(19.*k))^(3/2)) + (35.*Phi.*exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)))/(h.*k.*(exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)) + exp(-70.*((80.*h)/(19.*k))^(1/2)).*(h - k.*((80.*h)/(19.*k))^(1/2)))) - (40.*Phi.*exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)))/(19.*k^2.*(exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)) + exp(-70.*((80.*h)/(19.*k))^(1/2)).*(h - k.*((80.*h)/(19.*k))^(1/2))).*((80.*h)/(19.*k))^(3/2)) + (Phi.*exp(70.*((80.*h)/(19.*k))^(1/2)).*(40/(19.*((80.*h)/(19.*k))^(1/2)) + 1))/(k.*(exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)) + exp(-70.*((80.*h)/(19.*k))^(1/2)).*(h - k.*((80.*h)/(19.*k))^(1/2))).*((80.*h)/(19.*k))^(1/2)) + (Phi.*exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)).*(exp(-70.*((80.*h)/(19.*k))^(1/2)).*(40/(19.*((80.*h)/(19.*k))^(1/2)) - 1) - exp(70.*((80.*h)/(19.*k))^(1/2)).*(40/(19.*((80.*h)/(19.*k))^(1/2)) + 1) - (2800.*exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)))/(19.*k.*((80.*h)/(19.*k))^(1/2)) + (2800.*exp(-70.*((80.*h)/(19.*k))^(1/2)).*(h - k.*((80.*h)/(19.*k))^(1/2)))/(19.*k.*((80.*h)/(19.*k))^(1/2))))/(k.*(exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)) + exp(-70.*((80.*h)/(19.*k))^(1/2)).*(h - k.*((80.*h)/(19.*k))^(1/2)))^2.*((80.*h)/(19.*k))^(1/2))) - (35.*Phi.*exp(-x.*((80.*h)/(19.*k))^(1/2)).*exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)))/(h.*k.*(exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)) + exp(-70.*((80.*h)/(19.*k))^(1/2)).*(h - k.*((80.*h)/(19.*k))^(1/2)))) + (40.*Phi.*exp(-x.*((80.*h)/(19.*k))^(1/2)).*exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)))/(19.*k^2.*(exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)) + exp(-70.*((80.*h)/(19.*k))^(1/2)).*(h - k.*((80.*h)/(19.*k))^(1/2))).*((80.*h)/(19.*k))^(3/2)) - (Phi.*exp(-x.*((80.*h)/(19.*k))^(1/2)).*exp(70.*((80.*h)/(19.*k))^(1/2)).*(40/(19.*((80.*h)/(19.*k))^(1/2)) + 1))/(k.*(exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)) + exp(-70.*((80.*h)/(19.*k))^(1/2)).*(h - k.*((80.*h)/(19.*k))^(1/2))).*((80.*h)/(19.*k))^(1/2)) + (Phi.*x.*exp(-x.*((80.*h)/(19.*k))^(1/2)).*exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)))/(2.*h.*k.*(exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)) + exp(-70.*((80.*h)/(19.*k))^(1/2)).*(h - k.*((80.*h)/(19.*k))^(1/2)))) - (Phi.*exp(-x.*((80.*h)/(19.*k))^(1/2)).*exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)).*(exp(-70.*((80.*h)/(19.*k))^(1/2)).*(40/(19.*((80.*h)/(19.*k))^(1/2)) - 1) - exp(70.*((80.*h)/(19.*k))^(1/2)).*(40/(19.*((80.*h)/(19.*k))^(1/2)) + 1) - (2800.*exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)))/(19.*k.*((80.*h)/(19.*k))^(1/2)) + (2800.*exp(-70.*((80.*h)/(19.*k))^(1/2)).*(h - k.*((80.*h)/(19.*k))^(1/2)))/(19.*k.*((80.*h)/(19.*k))^(1/2))))/(k.*(exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)) + exp(-70.*((80.*h)/(19.*k))^(1/2)).*(h - k.*((80.*h)/(19.*k))^(1/2)))^2.*((80.*h)/(19.*k))^(1/2));
 
f_Phi=exp(x.*((80.*h)/(19.*k))^(1/2)).*(1/(k.*((80.*h)/(19.*k))^(1/2)) - (exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)))/(k.*(exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)) + exp(-70.*((80.*h)/(19.*k))^(1/2)).*(h - k.*((80.*h)/(19.*k))^(1/2))).*((80.*h)/(19.*k))^(1/2))) - (exp(-x.*((80.*h)/(19.*k))^(1/2)).*exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)))/(k.*(exp(70.*((80.*h)/(19.*k))^(1/2)).*(h + k.*((80.*h)/(19.*k))^(1/2)) + exp(-70.*((80.*h)/(19.*k))^(1/2)).*(h - k.*((80.*h)/(19.*k))^(1/2))).*((80.*h)/(19.*k))^(1/2));

S = [f_Phi' f_h' f_k'];
F = S'*S;
singvals = svd(S)
eigvals = eig(F)

S = [f_Phi' f_h'];
F = S'*S;
singvals = svd(S)
eigvals = eig(F)

figure(1)
plot(x, f_Phi_fin, '-k', x, f_Phi, '--m', x, f_Phi_fin, 'r*', 'linewidth',3)
set(gca,'Fontsize',22);
xlabel('Time')
ylabel('f_\Phi')
legend('Complex Step','Analytic','Finite Difference','Location','SouthEast') 

figure(2)
plot(x, f_h_fin, '-k', x, f_h, '--m', x, f_h_fin, 'r*', 'linewidth',3)
set(gca,'Fontsize',22);
xlabel('Time')
ylabel('f_h')
legend('Complex Step','Analytic','Finite Difference','Location','SouthEast') 

figure(3)
plot(x, f_k_fin, '-k', x, f_k, '--m', x, f_k_fin, 'r*', 'linewidth',3)
set(gca,'Fontsize',22);
xlabel('Time')
ylabel('f_k')
legend('Complex Step','Analytic','Finite Difference','Location','SouthEast') 

function u=analytic(x,k,h,Phi)
L =70;
a=.95;
b=.95;
T_amb = 21.29;
gamma = sqrt(2*(a+b)*h/(a*b*k));
f1 = exp(gamma*L)*(h + k*gamma);
f2 = exp(-gamma*L)*(h - k*gamma);
f3 = f1/(f2 + f1);
c1 = -Phi*f3/(k*gamma);
c2 = Phi/(k*gamma) + c1;
u = c1*exp(-gamma*x) + c2*exp(gamma*x) + T_amb;
end
 